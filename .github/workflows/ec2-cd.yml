name: EC2 CD Pipeline on AWS

on:
  workflow_run:
    workflows: ["Docker CI for Docker Hub Pipeline"]
    types:
      - completed

jobs:
  ec2-cd:
    runs-on: self-hosted
    steps:
      - name: Export env and docker compose
        run: |
          echo "The current directory is:"
          pwd
          echo "Listing contents of the current directory:"
          ls -la
          cd Flavorie 
          sudo IMAGE_TAG=$((${{github.run_number }})) docker compose down --volumes --remove-orphans
          sudo docker stop $(sudo docker ps -q) || true
          sudo docker rm $(sudo docker ps -aq) || true
          sudo docker system prune -a --volumes -f
          sudo IMAGE_TAG=$((${{github.run_number }} -1)) docker compose up -d --scale frontend=2 --scale backend=2 --scale peerjs=2 --no-recreate
          sudo docker rm -f $(sudo docker ps -q | xargs sudo docker inspect --format='{{.Name}}' | grep frontend | tail -n 1) 
          sudo docker rm -f $(sudo docker ps -q | xargs sudo docker inspect --format='{{.Name}}' | grep backend | tail -n 1)
          sudo docker rm -f $(sudo docker ps -q | xargs sudo docker inspect --format='{{.Name}}' | grep peerjs | tail -n 1)

          sudo docker exec $(sudo docker ps -q | xargs sudo docker inspect --format='{{.Name}}' | grep nginx) nginx -s reload
        working-directory: /home/ubuntu
